'use client';

import { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { TextInput, Slider, NameInput, SortableSelector } from '@/gradian-ui/form-builder/form-elements';
import type { SortableSelectorItem } from '@/gradian-ui/form-builder/form-elements';
import { FormSchema, CardSection, FormField } from '../types/form-schema';
import { Plus, Trash2, ChevronDown, ChevronUp } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { motion, AnimatePresence } from 'framer-motion';
import { IconRenderer } from '@/gradian-ui/shared/utils/icon-renderer';

interface CardMetadataTabProps {
  schema: FormSchema;
  onUpdate: (updates: Partial<FormSchema>) => void;
}

// Convert title to camelCase ID (similar to labelToCamelCase in FieldEditor)
const titleToId = (title: string): string => {
  if (!title) return '';
  
  return title
    .trim()
    .replace(/[^\w\s-]/g, '') // Remove special characters
    .split(/[\s_-]+/) // Split on spaces, underscores, or hyphens
    .map((word, index) => {
      if (index === 0) {
        return word.toLowerCase();
      }
      return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
    })
    .join('');
};

export function CardMetadataTab({ schema, onUpdate }: CardMetadataTabProps) {
  const [expandedSection, setExpandedSection] = useState<string | null>(null);
  const [customSectionIds, setCustomSectionIds] = useState<Record<string, boolean>>({});
  const cardMetadata = schema.cardMetadata || [];

  const allFields = schema.fields || [];
  const availableFields = allFields.filter(f => !f.inactive);

  const toggleSection = (sectionId: string) => {
    setExpandedSection(prev => prev === sectionId ? null : sectionId);
  };

  const addCardSection = () => {
    const defaultTitle = 'New Card Section';
    const autoGeneratedId = titleToId(defaultTitle) || `card-section-${Date.now()}`;
    const newSection: CardSection = {
      id: autoGeneratedId,
      title: defaultTitle,
      colSpan: 1,
      fieldIds: [],
    };
    onUpdate({ cardMetadata: [...cardMetadata, newSection] });
    setExpandedSection(newSection.id);
  };

  const updateCardSection = (sectionId: string, updates: Partial<CardSection>) => {
    const updated = cardMetadata.map(section =>
      section.id === sectionId ? { ...section, ...updates } : section
    );
    onUpdate({ cardMetadata: updated });
  };

  const handleTitleChange = (sectionId: string, newTitle: string) => {
    const section = cardMetadata.find(s => s.id === sectionId);
    if (!section) return;

    // Auto-generate ID from title if ID hasn't been manually edited
    if (!customSectionIds[sectionId]) {
      const autoGeneratedId = titleToId(newTitle);
      if (autoGeneratedId) {
        updateCardSection(sectionId, { title: newTitle, id: autoGeneratedId });
        return;
      }
    }
    
    updateCardSection(sectionId, { title: newTitle });
  };

  const handleIdChange = (sectionId: string, newId: string) => {
    setCustomSectionIds(prev => ({ ...prev, [sectionId]: true }));
    updateCardSection(sectionId, { id: newId });
  };

  const handleIdCustomModeChange = (sectionId: string, isCustom: boolean) => {
    setCustomSectionIds(prev => ({ ...prev, [sectionId]: isCustom }));
    
    if (!isCustom) {
      // Reset to auto-generated ID when turning customization off
      const section = cardMetadata.find(s => s.id === sectionId);
      if (section) {
        const autoGeneratedId = titleToId(section.title || '');
        if (autoGeneratedId) {
          updateCardSection(sectionId, { id: autoGeneratedId });
        }
      }
    }
  };

  const deleteCardSection = (sectionId: string) => {
    const updated = cardMetadata.filter(section => section.id !== sectionId);
    onUpdate({ cardMetadata: updated });
  };


  const convertFieldsToSelectorItems = (fields: FormField[]): SortableSelectorItem[] => {
    return fields.map(field => {
      // Check if field has badge-related properties
      const badgeVariant = (field as any).badgeVariant;
      const fieldColor = (field as any).color;
      const optionColor = field.options?.find(opt => opt.color)?.color;
      
      return {
        id: field.id,
        label: field.label || field.name,
        icon: field.icon ? <IconRenderer iconName={field.icon} className="h-3 w-3" /> : undefined,
        color: badgeVariant || fieldColor || optionColor,
      };
    });
  };

  const getSelectedFields = (section: CardSection): SortableSelectorItem[] => {
    const fieldIds = section.fieldIds || [];
    const selectedFields = fieldIds
      .map(id => availableFields.find(f => f.id === id))
      .filter((f): f is FormField => f !== undefined);
    return convertFieldsToSelectorItems(selectedFields);
  };

  const getAvailableFields = (section: CardSection): SortableSelectorItem[] => {
    const fieldIds = section.fieldIds || [];
    const unselectedFields = availableFields.filter(f => !fieldIds.includes(f.id));
    return convertFieldsToSelectorItems(unselectedFields);
  };

  const handleFieldSelectionChange = (sectionId: string, selectedItems: SortableSelectorItem[]) => {
    const fieldIds = selectedItems.map(item => item.id);
    updateCardSection(sectionId, { fieldIds });
  };

  return (
    <div className="space-y-4">
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <CardTitle>Card Metadata</CardTitle>
              <Badge variant="secondary" className="text-xs px-2 py-0.5">
                {cardMetadata.length} {cardMetadata.length === 1 ? 'section' : 'sections'}
              </Badge>
            </div>
            <Button onClick={addCardSection} size="sm" variant="outline">
              <Plus className="h-4 w-4 mr-2" />
              Add Section
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {cardMetadata.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              <p>No card sections defined. Add a section to configure how cards are displayed in list views.</p>
            </div>
          ) : (
            <AnimatePresence mode="popLayout">
              {cardMetadata.map((section, index) => (
                <motion.div
                  key={section.id}
                  initial={{ opacity: 0, y: -10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -10, height: 0 }}
                  transition={{ 
                    duration: 0.3, 
                    delay: index * 0.05,
                    ease: [0.4, 0, 0.2, 1]
                  }}
                  layout
                >
                  <Card className="border-gray-200">
                    <CardHeader className="pb-6">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2 flex-1">
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => toggleSection(section.id)}
                            className="h-8 w-8 p-0"
                          >
                            <motion.div
                              animate={{ rotate: expandedSection === section.id ? 180 : 0 }}
                              transition={{ duration: 0.3, ease: [0.4, 0, 0.2, 1] }}
                            >
                              <ChevronDown className="h-4 w-4" />
                            </motion.div>
                          </Button>
                          <CardTitle 
                            className="text-base cursor-pointer hover:text-violet-600 transition-colors flex-1"
                            onClick={() => toggleSection(section.id)}
                          >
                            {section.title || 'Untitled Section'}
                          </CardTitle>
                          <motion.div
                            initial={{ scale: 0.8, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            transition={{ duration: 0.2, delay: 0.1 }}
                          >
                            <Badge variant="secondary" className="text-xs px-2 py-0.5">
                              {section.fieldIds?.length || 0} {section.fieldIds?.length === 1 ? 'field' : 'fields'}
                            </Badge>
                          </motion.div>
                        </div>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => deleteCardSection(section.id)}
                          className="text-red-600 hover:text-red-700"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </CardHeader>
                    <AnimatePresence>
                      {expandedSection === section.id && (
                        <motion.div
                          initial={{ height: 0, opacity: 0 }}
                          animate={{ height: 'auto', opacity: 1 }}
                          exit={{ height: 0, opacity: 0 }}
                          transition={{ 
                            duration: 0.3, 
                            ease: [0.4, 0, 0.2, 1],
                            opacity: { duration: 0.2 }
                          }}
                          style={{ overflow: 'hidden' }}
                        >
                          <CardContent className="space-y-4 pt-2">
                    <div>
                      <TextInput
                        config={{ name: 'section-title', label: 'Card Section Title' }}
                        value={section.title || ''}
                        onChange={(value) => handleTitleChange(section.id, value)}
                      />
                    </div>
                    <div>
                      <NameInput
                        config={{ 
                          name: 'section-id', 
                          label: 'Card Section ID',
                          placeholder: 'Auto-generated from title'
                        }}
                        value={section.id}
                        onChange={(value) => handleIdChange(section.id, value)}
                        isCustomizable
                        customMode={customSectionIds[section.id] || false}
                        onCustomModeChange={(isCustom) => handleIdCustomModeChange(section.id, isCustom)}
                        customizeDisabled={false}
                        helperText={!customSectionIds[section.id] ? 'Card Section ID auto-generates from the title. Click "Customize" to override.' : undefined}
                      />
                    </div>
                    <div>
                      <Slider
                        config={{ name: 'col-span', label: 'Column Span' }}
                        value={section.colSpan || 1}
                        onChange={(value: number) => updateCardSection(section.id, { colSpan: value })}
                        min={1}
                        max={2}
                        step={1}
                      />
                      <p className="text-xs text-gray-500 mt-1">Number of columns this section spans (1 or 2)</p>
                    </div>
                    <div>
                      {availableFields.length === 0 ? (
                        <p className="text-sm text-gray-500">No fields available. Add fields in the Sections & Fields tab first.</p>
                      ) : (
                        <SortableSelector
                          availableItems={getAvailableFields(section)}
                          selectedItems={getSelectedFields(section)}
                          onChange={(selectedItems) => handleFieldSelectionChange(section.id, selectedItems)}
                          isSortable={true}
                          selectedLabel="Selected Fields"
                          availableLabel="Available Fields"
                          maxHeight="max-h-60"
                          emptySelectedMessage="No fields selected. Select fields below to add them."
                          emptyAvailableMessage="No fields available. Add fields in the Sections & Fields tab first."
                        />
                      )}
                    </div>
                          </CardContent>
                        </motion.div>
                      )}
                    </AnimatePresence>
                  </Card>
                </motion.div>
              ))}
            </AnimatePresence>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

